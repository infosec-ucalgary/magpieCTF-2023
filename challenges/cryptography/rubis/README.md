# Rubis
### Category: Cryptography
### Author: Delara (lara)

## Description
 
During our investigation of Omniflags, we came across a cluster of ships called Rubis that was used to store top-secret information randomly in one of the ships and would rotate this secret every few days to stop attackers from finding the secret. It has been long since Rubric was deprecated however, we found out Rubis still contains a key component that will assist in the rescue of the prisoners from the space prison. We managed to get the source code that was used to run Rubis and for better or for worse, Rubis is still running at `<ip>:<port>`. We need you to unlock the ship that contains the flag so we can save the prisoners. 

## Hints
1. Can you break RSA?
2. Is it truly random? 

## Solution
When we connect to the server we have a couple of options to choose from
1. Get previous ships
    This seems to be giving a list of 5 random numbers. Looking at the `setCurrentShip` function we see that the code is randomly generating 5 numbers first calling them previous ships and then choosing a random number again and setting that as the current ship i.e the ship that has the flag.

2. Get public certificate
    This gives us `n` and `e` from the RSA class we have. If we somehow figure out d we will be able to decrypt any text that was encrypted via this RSA.

3. Get password hint
    Looking through the source code we understand that the password hint is just the password for the current ship which was encrypted using the RSA.

4. Unlock ship
    This will ask for a ship number and will unlock that ship if you give it the correct password.

With all of that, we should be able to unlock the ship that contains the flag.

1. First, we need to decrypt the password. Looking closely at how the numbers for RSA are generated there would only be one thing that stands out from normal RSA algorithms and that is the way p and q are being generated. instead of generating `p` and `q` randomly, this algorithm is generating a random `x` and finds out the next and previous prime to `x`. This will make it so that `p` and `q` are really really close to each other. The most important part of RSA is that factoring is hard and if we are able factor `n` into two primes `p` and `q` we can break RSA. Now if `p` and `q` are close to each other, `n` can be factored into `p` and `q` quite fast using Fermat's factorization method. With this, we are able to factor `n` which was given by option 2 into `p` and `q`. Then we can generate `d` the same way the source code has generated `d` and decrypt the password using the decrypt method given to us as a guide. 
Password is: `f32m47'5_f4c702124710n_m37h0d_f02_7h3_w1n!!`

2. Now that we have the password for the ship we need to actually find out which ship actually contains the flag. The ship number is randomly generated but the key is that the random function in python is pseudorandom meaning that we can reproduce the random numbers generated by this function if we have the seed for it. Looking at the code we see that the seed for the random is set to be `round(time.time())`. What we have to do then is to set the seed for random to this and then decrement the time by one each time until we generated the same 5 numbers as the one generated from previous ships. Once we have those numbers matching we know that the next number generated by random() will be the current ship that contains the flag. 

3. Given the current ship number and the password, we should be able to unlock the ship and get the flag. 
4. An example solve script is in the solve folder. 
### References
Breaking RSA:
https://www.youtube.com/watch?v=-ShwJqAalOk
https://fermatattack.secvuln.info/

Random Number Generator Attack:
https://medium.com/@its_otr/snykcon-ctf-2021-random-flag-generator-983cda19d67f 

## Flag
`magpie{17_w45n'7_72u1y_24nd0m_4f732_411}`
